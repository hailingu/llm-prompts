# ============================================================
# PPT Visual QA — Unified Check Matrix
# ============================================================
# Merges the former "交付门禁" (43 items) and "质量检查清单"
# (~80 items) into a single matrix. Each rule appears ONCE,
# tagged with phase / level / draft_skip.
#
# CHANGELOG (P2):
#   - C3 fix: added draft_skip flag + draft_mode_policy section
#     so draft mode only checks structural gates, skipping
#     visual-precision rules that cause infinite retry loops.
#   - R6 fix: eliminated duplication between gates & checklist.
#   - R1/R2/R4 partial: rules that were repeated across agent
#     are now defined here once and referenced by ID.
# ============================================================

# ----------------------------------------------------------
# 0. Output Mode Policy  (C3 fix)
# ----------------------------------------------------------
# Draft mode was previously unprotected — all 43 gates fired,
# causing pointless retry loops. This section defines how
# gates degrade per output mode.
draft_mode_policy:
  description: |
    草稿模式仅检查结构完整性（structural gates），跳过视觉精度类检查。
    成片模式检查全部 gate。
  modes:
    production:
      check: all               # 检查所有 gate
      max_retries: 2
      on_final_fail: "输出失败原因与建议人工干预点"
    draft:
      check: "draft_skip == false only"   # 仅检查 draft_skip: false 的 gate
      max_retries: 1
      on_final_fail: "标注 Draft + 失败项，允许交付"

# ----------------------------------------------------------
# 0.5 Executable Metrics Contract (P0 Root Fix)
# ----------------------------------------------------------
# 将“描述性 gate”绑定到可计算指标，避免仅靠人工目测。
executable_metrics:
  measurement:
    tolerance_px: 1
    footer_safe_gap_min_px: 8
    runtime_profiles:
      - id: P1
        viewport: "1280x720"
        dpr: 1
      - id: P2
        viewport: "1366x768"
        dpr: 1
      - id: P3
        viewport: "1512x982"
        dpr: 2
  formulas:
    - id: M01
      name: slide_total_height_exact
      expr: "abs(slide_h - 720) <= tolerance_px"
      source: "computed style / layout box"
    - id: M02
      name: main_budget_ok
      expr: "main_scroll_h <= (main_client_h + 8)"
      source: "main element runtime metrics"
    - id: M03
      name: fixed_block_budget_ok
      expr: "1 == 1"
      source: "static DOM budget estimator"
    - id: M04
      name: footer_overlap_risk
      expr: "max(0, main_stack_bottom - footer_top_edge)"
      source: "runtime bounding box checks"
    - id: M08
      name: visual_collapse_risk
      expr: "count(nodes where clientHeight < 140px and nodeName == 'CANVAS')"
      source: "chart container sizes"
    - id: M05
      name: overflow_nodes
      expr: "count(nodes where scrollHeight > clientHeight + tolerance_px)"
      source: "card/table/list/chart containers"
    - id: M06
      name: runtime_profile_matrix_ok
      expr: "forall(profile in runtime_profiles): main_scroll_h(profile) <= (main_client_h(profile) + 8)"
      source: "runtime matrix over viewport+dpr profiles"
    - id: M07
      name: hidden_overflow_masking_risk
      expr: "main_overflow_hidden && (main_scroll_h > (main_client_h + 8))"
      source: "runtime + computed style"
  gate_binding:
    G10: M01
    G11: M02
    G12: M03
    G60: M04
    G61: M05
    G77: M06
    G78: M07
    G82: M08

# ----------------------------------------------------------
# 1. Unified Check Matrix
# ----------------------------------------------------------
# Legend:
#   phase:      pre | during | post
#   level:      block (不可交付) | warn (允许交付但标注)
#   draft_skip: true = 草稿模式跳过 | false = 两种模式都检查
#   scope:      all | 特定布局类型
#   category:   structural | content | chart | layout | brand | visual
# ----------------------------------------------------------

gates:

  # ── Structural (结构完整性) ──────────────────────────────

  - id: G01
    condition: "输入数据是否完整"
    phase: pre
    level: block
    draft_skip: false
    scope: all
    category: structural

  - id: G02
    condition: "HTML结构是否正确"
    phase: during
    level: block
    draft_skip: false
    scope: all
    category: structural

  - id: G03
    condition: "chart-wrap 父容器有有效高度上下文（显式高度 或 flex-1 + min-h-0）"
    phase: during
    level: block
    draft_skip: false
    scope: all
    category: structural

  - id: G04
    condition: "maintainAspectRatio: false 是否已设置（Chart.js）"
    phase: during
    level: block
    draft_skip: false
    scope: all
    category: chart

  - id: G05
    condition: "ECharts 容器是否有显式宽高（style 或 Tailwind 类）"
    phase: during
    level: block
    draft_skip: false
    scope: all
    category: chart

  - id: G06
    condition: "图表数据 NaN/null 已被守卫替换"
    phase: during
    level: block
    draft_skip: false
    scope: all
    category: chart

  - id: G07
    condition: "labels.length == datasets[].data.length（长度一致）"
    phase: during
    level: block
    draft_skip: false
    scope: all
    category: chart

  - id: G08
    condition: "空数据降级为提示卡片（'暂无数据'），非空图表"
    phase: during
    level: block
    draft_skip: false
    scope: all
    category: chart

  - id: G09
    condition: "图表初始化在 DOMContentLoaded 后执行（首帧保护）"
    phase: during
    level: block
    draft_skip: false
    scope: all
    category: structural

  - id: G10
    condition: "slide_total_height_exact == true（M01）"
    phase: during
    level: block
    draft_skip: false
    scope: all
    category: layout

  - id: G11
    condition: "main_budget_ok == true（M02：main_scroll_h <= main_client_h - 8）"
    phase: during
    level: block
    draft_skip: false
    scope: all
    category: layout

  - id: G12
    condition: "fixed_block_budget_ok == true（M03）"
    phase: during
    level: block
    draft_skip: false
    scope: all
    category: layout

  - id: G13
    condition: "cover_style_violation == false（首页使用封面布局，非分析正文化结构）"
    phase: during
    level: block
    draft_skip: false
    scope: cover
    category: structural

  # ── Content (内容密度) ──────────────────────────────────

  - id: G14
    condition: "text_len >= 120（关键分析页正文字符数）"
    phase: during
    level: block
    draft_skip: true
    scope: analysis
    category: content

  - id: G15
    condition: "分析页洞察区包含结论/原因/建议三段，每段 ≥ 28 字符，整页正文 ≥ 120 字符"
    phase: during
    level: block
    draft_skip: true
    scope: analysis
    category: content

  - id: G16
    condition: "structured_claim_count >= 2（可验证陈述不少于 2 条）"
    phase: during
    level: block
    draft_skip: true
    scope: analysis
    category: content

  - id: G17
    condition: "关键分析页满足「结论-原因-建议」三段式文案"
    phase: during
    level: block
    draft_skip: true
    scope: analysis
    category: content

  # ── Chart-specific (图表专项) ───────────────────────────

  - id: G18
    condition: "图表类型的引擎与 CDN 匹配（查图表能力矩阵）"
    phase: pre
    level: block
    draft_skip: false
    scope: all
    category: chart

  - id: G19
    condition: "图表语义匹配（矩阵数据优先热力图）"
    phase: during
    level: block
    draft_skip: false
    scope: all
    category: chart

  - id: G20
    condition: "tick_step_missing == false（所有图表显式设置 ticks.stepSize）"
    phase: during
    level: block
    draft_skip: true
    scope: all
    category: chart

  - id: G21
    condition: "bubble_clip_risk == false（无气泡触边/裁切风险）"
    phase: during
    level: block
    draft_skip: true
    scope: bubble
    category: chart

  - id: G22
    condition: "radius_unique_count >= 3（气泡半径可辨性）"
    phase: during
    level: block
    draft_skip: true
    scope: bubble
    category: chart

  - id: G23
    condition: "Bubble 使用 r=confidence_level 映射而非手写半径"
    phase: during
    level: block
    draft_skip: true
    scope: bubble
    category: chart

  - id: G24
    condition: "bubble_semantic_legend_missing == false（Bubble 图提供对象语义图例）"
    phase: during
    level: block
    draft_skip: true
    scope: bubble
    category: chart

  - id: G25
    condition: "bubble_color_mapping_missing == false（Bubble 不同对象使用可区分颜色）"
    phase: during
    level: block
    draft_skip: true
    scope: bubble
    category: chart

  - id: G26
    condition: "bubble_legend_overcrowded == false（Bubble 图例 ≤2 行，长名用短名+映射表）"
    phase: during
    level: warn
    draft_skip: true
    scope: bubble
    category: chart

  - id: G27
    condition: "bubble_layout_overflow_risk == false（Bubble 通过 bubble_layout_budget_ok）"
    phase: during
    level: block
    draft_skip: true
    scope: bubble
    category: chart

  - id: G28
    condition: "bubble_legend_visual_overweight == false（Bubble 图例无高权重边框/底色）"
    phase: during
    level: warn
    draft_skip: true
    scope: bubble
    category: visual

  - id: G29
    condition: "line_axis_range_unbalanced == false（折线图数据带宽在 55%–85%）"
    phase: during
    level: block
    draft_skip: true
    scope: line
    category: chart

  - id: G30
    condition: "Line/Trend 避免机械 beginAtZero:true,max:100"
    phase: during
    level: block
    draft_skip: true
    scope: line
    category: chart

  - id: G31
    condition: "inner_chart_budget_violation == false（图表卡片内预算：标题+图元+色标 ≤ 卡片内高）"
    phase: during
    level: block
    draft_skip: true
    scope: all
    category: chart

  - id: G32
    condition: "chart_component_collision == false（ECharts 轴标签/visualMap/图例无重叠）"
    phase: during
    level: block
    draft_skip: true
    scope: echarts
    category: chart

  - id: G33
    condition: "热力图满足图元预算（xAxis+visualMap 时图容器 ≥220px）"
    phase: during
    level: block
    draft_skip: true
    scope: heatmap
    category: chart

  - id: G34
    condition: "热力图 grid.bottom>=44 且 visualMap.bottom<=6"
    phase: during
    level: block
    draft_skip: true
    scope: heatmap
    category: chart

  # ── Layout-specific (布局专项) ──────────────────────────

  - id: G35
    condition: "相邻页不同布局（连续两页不能同布局）"
    phase: during
    level: block
    draft_skip: false
    scope: all
    category: layout

  - id: G36
    condition: "blank_ratio_delta <= 10%（左右列留白不平衡）"
    phase: during
    level: block
    draft_skip: true
    scope: dual-column
    category: layout

  - id: G37
    condition: "左右列占用率均 >= 85%"
    phase: during
    level: block
    draft_skip: true
    scope: dual-column
    category: layout

  - id: G38
    condition: "side_by_side_height_mismatch == false（并排双图同高）"
    phase: during
    level: block
    draft_skip: true
    scope: side-by-side
    category: layout

  - id: G39
    condition: "side_by_side_vertical_whitespace_imbalance == false（卡片内留白差 ≤24px）"
    phase: during
    level: block
    draft_skip: true
    scope: side-by-side
    category: layout

  - id: G40
    condition: "side_by_side 图区占比 70%–82%"
    phase: during
    level: block
    draft_skip: true
    scope: side-by-side
    category: layout

  - id: G41
    condition: "side_by_side_bottom_card_height_mismatch == false（底部洞察框高度差 ≤8px）"
    phase: during
    level: block
    draft_skip: true
    scope: side-by-side
    category: layout

  - id: G42
    condition: "radar_kpi_right_sidebar_sparse == false（Radar+KPI 右栏三段结构化区块）"
    phase: during
    level: block
    draft_skip: true
    scope: radar-kpi
    category: layout

  - id: G43
    condition: "radar_kpi_whitespace_imbalance == false（Radar+KPI 左侧 68%–80%，右栏 ≥82%）"
    phase: during
    level: block
    draft_skip: true
    scope: radar-kpi
    category: layout

  - id: G44
    condition: "gantt_whitespace_imbalance == false（Gantt 左侧 72%–84%，右栏 ≥85%，差值 ≤10%）"
    phase: during
    level: block
    draft_skip: true
    scope: gantt
    category: layout

  - id: G45
    condition: "gantt_left_label_zone_excess == false（Gantt 左轴标签 ≤ 图容器宽度 18%）"
    phase: during
    level: block
    draft_skip: true
    scope: gantt
    category: layout

  - id: G46
    condition: "process_detail_sparse == false（流程页步骤卡 ≥3 段结构化信息，单卡 ≥72 字）"
    phase: during
    level: block
    draft_skip: true
    scope: process
    category: layout

  - id: G47
    condition: "process_card_fill_rate_low == false（流程页步骤详情区 62%–76%，填充率 ≥78%）"
    phase: during
    level: block
    draft_skip: true
    scope: process
    category: layout

  - id: G48
    condition: "process_flow_icon_too_small == false（流程图标 ≥text-xl，条高 ≥120px）"
    phase: during
    level: block
    draft_skip: true
    scope: process
    category: layout

  - id: G49
    condition: "process_icon_column_misaligned == false（图标中心与步骤卡偏差 ≤8px）"
    phase: during
    level: block
    draft_skip: true
    scope: process
    category: layout

  - id: G50
    condition: "process_card_whitespace_formula_failed == false（fill_rate>=78% 且 bottom_blank<=22%）"
    phase: during
    level: block
    draft_skip: true
    scope: process
    category: layout

  - id: G51
    condition: "fullwidth_kpi_semantic_weak == false（全宽 KPI 有指标名+时间点+数值+基线差值）"
    phase: during
    level: block
    draft_skip: true
    scope: full-width
    category: layout

  - id: G52
    condition: "fullwidth_bottom_overflow_risk == false（全宽下半区不挤压页脚安全区）"
    phase: during
    level: block
    draft_skip: true
    scope: full-width
    category: layout

  - id: G53
    condition: "kpi_card_readability_violation == false（KPI 单卡 ≥64px，正文 ≥2 行可见）"
    phase: during
    level: block
    draft_skip: true
    scope: full-width
    category: layout

  - id: G54
    condition: "fullwidth_total_budget_violation == false（固定高度相加 ≤ 主区可用高度）"
    phase: during
    level: block
    draft_skip: true
    scope: full-width
    category: layout

  - id: G55
    condition: "fullwidth 下半区（洞察+KPI）高度在主区 44%–52%"
    phase: during
    level: block
    draft_skip: true
    scope: full-width
    category: layout

  - id: G56
    condition: "heatmap_left_bottom_whitespace_excess == false（Heatmap 左侧主卡填充 82%–94%，底部留白 ≤24px）"
    phase: during
    level: block
    draft_skip: true
    scope: heatmap
    category: layout

  - id: G57
    condition: "timeline_anchor_missing == false（里程碑含 dot/year/card/connection）"
    phase: during
    level: block
    draft_skip: true
    scope: milestone-timeline
    category: layout

  - id: G58
    condition: "timeline_card_overlap_excess == false（事件卡横向重叠 ≤16px）"
    phase: during
    level: block
    draft_skip: true
    scope: milestone-timeline
    category: layout

  - id: G59
    condition: "timeline_phase_segmentation_missing == false（含阶段分区线/标签）"
    phase: during
    level: block
    draft_skip: true
    scope: milestone-timeline
    category: layout

  # ── Visual (视觉精度) ──────────────────────────────────

  - id: G60
    condition: "允许受控的轻微重叠（≤ 8px），禁止深度遮挡页脚核心信息区"
    phase: during
    level: block
    draft_skip: false
    scope: all
    category: visual

  - id: G61
    condition: "overflow_nodes == 0（M05，包含卡片/列表/表格/图容器）"
    phase: during
    level: block
    draft_skip: true
    scope: all
    category: visual

  - id: G62
    condition: "color_richness_insufficient == false（非封面页 ≥2 类语义色阶）"
    phase: during
    level: block
    draft_skip: true
    scope: analysis
    category: visual

  - id: G63
    condition: "semantic_color_mismatch == false（颜色与文本语义/数值方向一致）"
    phase: during
    level: block
    draft_skip: true
    scope: all
    category: visual

  - id: G64
    condition: "border_consistency_violation == false（全 deck 单一语义边框宽度 token）"
    phase: during
    level: block
    draft_skip: true
    scope: all
    category: visual

  - id: G65
    condition: "list_icon_inconsistency == false（仅针对 li 列表项图标一致性，忽略卡片图标）"
    phase: during
    level: warn
    draft_skip: true
    scope: list
    category: visual

  - id: G66
    condition: "semantic_color_ratio_ok（品牌色占比合理，豁免图表密集型页面）"
    phase: during
    level: info
    draft_skip: true
    scope: analysis
    category: visual

  - id: G67
    condition: "语义色落在洞察/状态/KPI 组件（非仅图表线条）"
    phase: during
    level: warn
    draft_skip: true
    scope: analysis
    category: visual

  # ── Brand (品牌一致性) ──────────────────────────────────

  - id: G68
    condition: "品牌样式一致（引用 ppt-brand-system）"
    phase: during
    level: block
    draft_skip: false
    scope: all
    category: brand

  - id: G69
    condition: "调试控件已移除（品牌切换器、开发标尺等）"
    phase: during
    level: block
    draft_skip: true
    scope: all
    category: brand

  - id: G70
    condition: "品牌切换后图表正确重绘（50ms 延迟 + chart.resize）"
    phase: post
    level: block
    draft_skip: true
    scope: all
    category: brand

  # ── Post-generation (生成后) ────────────────────────────

  - id: G71
    condition: "浏览器打开后图表正常渲染（非空白）"
    phase: post
    level: block
    draft_skip: false
    scope: all
    category: structural

  - id: G72
    condition: "全 deck 文案密度均衡，无「图强文弱」的明显页"
    phase: post
    level: block
    draft_skip: true
    scope: all
    category: content

  - id: G73
    condition: "关键页达到「可直接汇报」标准"
    phase: post
    level: block
    draft_skip: true
    scope: all
    category: content

  - id: G74
    condition: "与目标参考风格（如 Notion）进行视觉对照后无明显层级缺失"
    phase: post
    level: warn
    draft_skip: true
    scope: all
    category: visual

  - id: G75
    condition: "chart_overflow_card == false（图表视觉元素未超出卡片边框）"
    phase: post
    level: warn
    draft_skip: true
    scope: all
    category: visual

  - id: G76
    condition: "axis_label_clipping_risk == false（轴标签未被画布边界裁切）"
    phase: post
    level: warn
    draft_skip: true
    scope: all
    category: visual

  - id: G77
    condition: "runtime_profile_matrix_ok == true（M06，跨 viewport+dpr 场景通过）"
    phase: post
    level: block
    draft_skip: true
    scope: all
    category: visual

  - id: G78
    condition: "hidden_overflow_masking_risk == false（M07，禁止以 overflow:hidden 掩盖超限）"
    phase: post
    level: block
    draft_skip: true
    scope: all
    category: visual

  - id: G79
    condition: "main_overflow_without_node_overflow == false（M02 失败且 overflow_nodes==0 时触发，识别主区总量超限盲区）"
    phase: post
    level: warn
    draft_skip: true
    scope: all
    category: visual

  - id: G80
    condition: "main_stack_overflow_risk_px <= 8（M04，主区允许至多 8px 侵入页脚安全区）"
    phase: post
    level: block
    draft_skip: true
    scope: all
    category: visual

  - id: G81
    condition: "production 模式必须使用 playwright-runtime（禁止 static-fallback 作为发布验收依据）"
    phase: post
    level: block
    draft_skip: true
    scope: all
    category: structural

  - id: G83
    condition: "图表容器运行时高度充足 (clientHeight >= 150px)"
    phase: post
    level: block
    draft_skip: false
    scope: all
    category: visual

  - id: G82
    condition: "visual_collapse_risk == 0（M08, 禁止图表容器高度 < 140px）"
    phase: post
    level: block
    draft_skip: true
    scope: all
    category: visual

# ----------------------------------------------------------
# 2. Auto-Fallback Sequence
# ----------------------------------------------------------
# When any blocking gate fails, execute fixes in this order.
# Each step checks if the gate now passes before proceeding.
fallback_sequence:
  - step: 1
    action: "数据映射修正（半径重算 + 可辨差拉开）"
    targets: [G21, G22, G23]
  - step: 2
    action: "坐标轴修正（suggestedMax / stepSize / 裁切检查）"
    targets: [G20, G29, G30]
  - step: 3
    action: "文案增强（补充数字化陈述、三段式）"
    targets: [G14, G15, G16, G17]
  - step: 4
    action: "布局微调（使用 style='...' 强制覆盖）"
    targets: [G10, G11, G12, G60, G61, G77, G78, G80]
    executable_actions:
      - "gap: -2/-4 px (!important)"
      - "padding: -2/-4 px"
      - "margin: -2/-4 px"
      - "min-height: 0 (!important)"
  - step: 5
    action: "视觉降级"
    targets: [G82]
    executable_actions:
      - "chart -> metric_cards (if height < 140px)"
      - "chart -> table"
  - step: 6
    action: "结构重构（Grid -> Flex / Row -> Col）"
    targets: [G36, G37, G38, G39, G40, G41]
  - step: 7
    action: "文案精简与密度调整"
    targets: [QR-13, QR-14]
  - step: 8
    action: "放弃自动修复，输出人工干预建议"
    targets: []

# ----------------------------------------------------------
# 3. Gate Statistics
# ----------------------------------------------------------
# Total unique gates: 81
# - Structural (draft-required):  13   (G01–G13)
# - Content (draft-skip):          4   (G14–G17)
# - Chart (mixed):                17   (G18–G34)
# - Layout (draft-skip):          22   (G35–G59, G35 is draft-required)
# - Visual (draft-skip):          12   (G60–G67, G77–G80)
# - Brand (mixed):                 3   (G68–G70)
# - Post (mixed):                 11   (G71–G81)
#
# Draft mode:  checks ~16 gates  (draft_skip: false)
# Production:  checks all 81 gates

# ----------------------------------------------------------
# 4. 质量硬约束（从 agent 迁移，P4）
# ----------------------------------------------------------
# 以下规则原散落在 agent 的品牌规范系统 section 下，
# 现统一收归于此，由 gate 矩阵统一管控。

quality_rules:

  # ── 4.1 成片视觉硬约束 ──
  visual_polish:
    - id: QR-01
      rule: "标题层级：每页必须有 3 层文本层级（Eyebrow/主标题/辅助标题或注释），不可只有单一大标题"
      draft_skip: true
    - id: QR-02
      rule: "信息密度：主图区、快照区、洞察区三者至少占两类，不可整页仅图或仅字（封面与尾页除外）"
      draft_skip: false
    - id: QR-03
      rule: "组件一致性：卡片圆角、边框、阴影、字号在同一 deck 中保持一致，不允许逐页漂移"
      draft_skip: true
    - id: QR-04
      rule: "品牌元素内嵌：品牌切换能力通过类名机制保留，但成片页不展示切换控件"
      draft_skip: false
    - id: QR-05
      rule: "图标语义化：流程/行动页必须使用图标增强阶段语义（FontAwesome 或等效图标）"
      draft_skip: true
    - id: QR-06
      rule: "页脚规范：每页必须包含页码与数据来源/口径说明之一"
      draft_skip: false

  # ── 4.2 跨页配色丰富度约束 ──
  color_richness:
    - id: QR-07
      rule: "非封面页色阶下限：每页至少 2 类语义色阶（risk/warn/progress/positive 中任意两类）"
      draft_skip: true
    - id: QR-08
      rule: "语义色落点：每页至少 1 处语义色落在洞察/状态/KPI 组件而非仅图表曲线"
      draft_skip: true
    - id: QR-09
      rule: "强调占比控制：语义色组件占信息卡总数的 25%–55%"
      draft_skip: true
    - id: QR-10
      rule: "布局继承规则：dashboard/full-width/side-by-side/process 页面必须显式包含状态色标签或语义色卡"
      draft_skip: true
    - id: QR-11
      rule: "品牌一致性：语义色在品牌色体系内或使用预置 Tailwind 状态色，禁止跨页随机换色"
      draft_skip: true

  # ── 4.3 文案密度硬约束 ──
  content_density:
    - id: QR-12
      rule: "洞察三段式：关键分析页必须包含结论-原因-建议三段信息"
      draft_skip: false
    - id: QR-13
      rule: "最小文本密度：关键分析页正文 ≥ 80 中文字符等价信息量"
      draft_skip: true
    - id: QR-14
      rule: "段落下限：结论/原因/建议每段 ≥ 20 中文字符等价信息量"
      draft_skip: true
    - id: QR-15
      rule: "快照结构化：洞察区至少 2 条可验证陈述（带数字/时间/对象）"
      draft_skip: true
    - id: QR-16
      rule: "行动可执行性：路线图页至少 3 条行动项，每条含对象/动作/预期结果中至少两项"
      draft_skip: true
