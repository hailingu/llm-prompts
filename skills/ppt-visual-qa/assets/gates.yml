# ============================================================
# PPT Visual QA — Gate Definitions
# ============================================================
# Unified check matrix for PPT HTML slides quality assurance.
# Each gate is tagged with phase / level / draft_skip for mode-aware checking.
#
# Legend:
#   phase:      pre | during | post
#   level:      block (non-deliverable) | warn (deliverable with annotation)
#   draft_skip: true = skip in draft mode | false = check in both modes
#   scope:      all | specific layout type
#   category:   structural | content | chart | layout | brand | visual
# ============================================================

gates:

  # ── Structural (Structural Integrity) ──────────────────────────────

  - id: G01
    condition: "Input data is complete"
    phase: pre
    level: block
    draft_skip: false
    scope: all
    category: structural

  - id: G02
    condition: "HTML structure is correct"
    phase: during
    level: block
    draft_skip: false
    scope: all
    category: structural

  - id: G03
    condition: "chart-wrap parent container has valid height context (explicit height OR flex-1 + min-h-0)"
    phase: during
    level: block
    draft_skip: false
    scope: all
    category: structural

  - id: G04
    condition: "maintainAspectRatio: false is set (Chart.js)"
    phase: during
    level: block
    draft_skip: false
    scope: all
    category: chart

  - id: G05
    condition: "ECharts container has explicit width/height (style or Tailwind class)"
    phase: during
    level: block
    draft_skip: false
    scope: all
    category: chart

  - id: G06
    condition: "Chart data NaN/null has been guarded and replaced"
    phase: during
    level: block
    draft_skip: false
    scope: all
    category: chart

  - id: G07
    condition: "labels.length == datasets[].data.length (lengths match)"
    phase: during
    level: block
    draft_skip: false
    scope: all
    category: chart

  - id: G08
    condition: "Empty data falls back to info card ('No data available'), not empty chart"
    phase: during
    level: block
    draft_skip: false
    scope: all
    category: chart

  - id: G09
    condition: "Chart initialization executes after DOMContentLoaded (first-frame protection)"
    phase: during
    level: block
    draft_skip: false
    scope: all
    category: structural

  - id: G10
    condition: "slide_total_height_exact == true (M01)"
    phase: during
    level: block
    draft_skip: false
    scope: all
    category: layout

  - id: G11
    condition: "main_budget_ok == true (M02: main_scroll_h <= main_client_h - 8)"
    phase: during
    level: block
    draft_skip: false
    scope: all
    category: layout

  - id: G12
    condition: "fixed_block_budget_ok == true (M03)"
    phase: during
    level: block
    draft_skip: false
    scope: all
    category: layout

  - id: G13
    condition: "cover_style_violation == false (cover page uses cover layout, not analysis content structure)"
    phase: during
    level: block
    draft_skip: false
    scope: cover
    category: structural

  # ── Content (Content Density) ──────────────────────────────────

  - id: G14
    condition: "text_len >= 120 (key analysis page body character count)"
    phase: during
    level: block
    draft_skip: true
    scope: analysis
    category: content

  - id: G15
    condition: "Analysis page insight section contains conclusion/cause/recommendation three parts, each >= 28 chars, whole page body >= 120 chars"
    phase: during
    level: block
    draft_skip: true
    scope: analysis
    category: content

  - id: G16
    condition: "structured_claim_count >= 2 (at least 2 verifiable statements)"
    phase: during
    level: block
    draft_skip: true
    scope: analysis
    category: content

  - id: G17
    condition: "Key analysis pages satisfy 'conclusion-cause-recommendation' three-part copy"
    phase: during
    level: block
    draft_skip: true
    scope: analysis
    category: content

  # ── Chart-specific ───────────────────────────

  - id: G18
    condition: "Chart type engine matches CDN (check chart capability matrix)"
    phase: pre
    level: block
    draft_skip: false
    scope: all
    category: chart

  - id: G19
    condition: "Chart semantic matching (matrix data prefers heatmap)"
    phase: during
    level: block
    draft_skip: false
    scope: all
    category: chart

  - id: G20
    condition: "tick_step_missing == false (all charts explicitly set ticks.stepSize)"
    phase: during
    level: block
    draft_skip: true
    scope: all
    category: chart

  - id: G21
    condition: "bubble_clip_risk == false (no bubble edge/clipping risk)"
    phase: during
    level: block
    draft_skip: true
    scope: bubble
    category: chart

  - id: G22
    condition: "radius_unique_count >= 3 (bubble radius distinguishability)"
    phase: during
    level: block
    draft_skip: true
    scope: bubble
    category: chart

  - id: G23
    condition: "Bubble uses r=confidence_level mapping instead of hardcoded radius"
    phase: during
    level: block
    draft_skip: true
    scope: bubble
    category: chart

  - id: G24
    condition: "bubble_semantic_legend_missing == false (Bubble chart provides object semantic legend)"
    phase: during
    level: block
    draft_skip: true
    scope: bubble
    category: chart

  - id: G25
    condition: "bubble_color_mapping_missing == false (Bubble different objects use distinguishable colors)"
    phase: during
    level: block
    draft_skip: true
    scope: bubble
    category: chart

  - id: G26
    condition: "bubble_legend_overcrowded == false (Bubble legend <=2 rows, long names use short names + mapping table)"
    phase: during
    level: warn
    draft_skip: true
    scope: bubble
    category: chart

  - id: G27
    condition: "bubble_layout_overflow_risk == false (Bubble passes bubble_layout_budget_ok)"
    phase: during
    level: block
    draft_skip: true
    scope: bubble
    category: chart

  - id: G28
    condition: "bubble_legend_visual_overweight == false (Bubble legend has no high-weight border/background)"
    phase: during
    level: warn
    draft_skip: true
    scope: bubble
    category: visual

  - id: G29
    condition: "line_axis_range_unbalanced == false (line chart data bandwidth in 55%-85%)"
    phase: during
    level: block
    draft_skip: true
    scope: line
    category: chart

  - id: G30
    condition: "Line/Trend avoid mechanical beginAtZero:true,max:100"
    phase: during
    level: block
    draft_skip: true
    scope: line
    category: chart

  - id: G31
    condition: "inner_chart_budget_violation == false (chart card internal budget: title+glyphs+legend <= card inner height)"
    phase: during
    level: block
    draft_skip: true
    scope: all
    category: chart

  - id: G32
    condition: "chart_component_collision == false (ECharts axis labels/visualMap/legend have no overlap)"
    phase: during
    level: block
    draft_skip: true
    scope: echarts
    category: chart

  - id: G33
    condition: "Heatmap satisfies glyph budget (xAxis+visualMap requires chart container >=220px)"
    phase: during
    level: block
    draft_skip: true
    scope: heatmap
    category: chart

  - id: G34
    condition: "Heatmap grid.bottom>=44 and visualMap.bottom<=6"
    phase: during
    level: block
    draft_skip: true
    scope: heatmap
    category: chart

  # ── Layout-specific ──────────────────────────

  - id: G35
    condition: "Adjacent pages have different layouts (consecutive pages cannot share same layout)"
    phase: during
    level: block
    draft_skip: false
    scope: all
    category: layout

  - id: G36
    condition: "Left-right column whitespace imbalance <= 10% (blank_ratio_delta <= 10%)"
    phase: during
    level: block
    draft_skip: true
    scope: dual-column
    category: layout

  - id: G37
    condition: "Left-right column occupancy rate both >= 85%"
    phase: during
    level: block
    draft_skip: true
    scope: dual-column
    category: layout

  - id: G38
    condition: "side_by_side_height_mismatch == false (side-by-side dual charts have same height)"
    phase: during
    level: block
    draft_skip: true
    scope: side-by-side
    category: layout

  - id: G39
    condition: "side_by_side_vertical_whitespace_imbalance == false (card internal whitespace diff <=24px)"
    phase: during
    level: block
    draft_skip: true
    scope: side-by-side
    category: layout

  - id: G40
    condition: "side_by_side chart area ratio 70%-82%"
    phase: during
    level: block
    draft_skip: true
    scope: side-by-side
    category: layout

  - id: G41
    condition: "side_by_side_bottom_card_height_mismatch == false (bottom insight box height diff <=8px)"
    phase: during
    level: block
    draft_skip: true
    scope: side-by-side
    category: layout

  - id: G42
    condition: "radar_kpi_right_sidebar_sparse == false (Radar+KPI right column has three-part structured blocks)"
    phase: during
    level: block
    draft_skip: true
    scope: radar-kpi
    category: layout

  - id: G43
    condition: "radar_kpi_whitespace_imbalance == false (Radar+KPI left 68%-80%, right column >=82%)"
    phase: during
    level: block
    draft_skip: true
    scope: radar-kpi
    category: layout

  - id: G44
    condition: "gantt_whitespace_imbalance == false (Gantt left 72%-84%, right column >=85%, diff <=10%)"
    phase: during
    level: block
    draft_skip: true
    scope: gantt
    category: layout

  - id: G45
    condition: "gantt_left_label_zone_excess == false (Gantt left axis labels <= chart container width 18%)"
    phase: during
    level: block
    draft_skip: true
    scope: gantt
    category: layout

  - id: G46
    condition: "process_detail_sparse == false (Process page step cards >=3 structured info blocks, single card >=72 chars)"
    phase: during
    level: block
    draft_skip: true
    scope: process
    category: layout

  - id: G47
    condition: "process_card_fill_rate_low == false (Process page step details area 62%-76%, fill rate >=78%)"
    phase: during
    level: block
    draft_skip: true
    scope: process
    category: layout

  - id: G48
    condition: "process_flow_icon_too_small == false (Process icon >=text-xl, bar height >=120px)"
    phase: during
    level: block
    draft_skip: true
    scope: process
    category: layout

  - id: G49
    condition: "process_icon_column_misaligned == false (Icon center vs step card deviation <=8px)"
    phase: during
    level: block
    draft_skip: true
    scope: process
    category: layout

  - id: G50
    condition: "process_card_whitespace_formula_failed == false (fill_rate>=78% AND bottom_blank<=22%)"
    phase: during
    level: block
    draft_skip: true
    scope: process
    category: layout

  - id: G51
    condition: "fullwidth_kpi_semantic_weak == false (Full-width KPI has metric name+time point+value+baseline diff)"
    phase: during
    level: block
    draft_skip: true
    scope: full-width
    category: layout

  - id: G52
    condition: "fullwidth_bottom_overflow_risk == false (Full-width lower half does not compress footer safety zone)"
    phase: during
    level: block
    draft_skip: true
    scope: full-width
    category: layout

  - id: G53
    condition: "kpi_card_readability_violation == false (KPI single card >=64px, body text >=2 lines visible)"
    phase: during
    level: block
    draft_skip: true
    scope: full-width
    category: layout

  - id: G54
    condition: "fullwidth_total_budget_violation == false (Fixed heights sum <= main area available height)"
    phase: during
    level: block
    draft_skip: true
    scope: full-width
    category: layout

  - id: G55
    condition: "fullwidth lower half (insight+KPI) height in main area 44%-52%"
    phase: during
    level: block
    draft_skip: true
    scope: full-width
    category: layout

  - id: G56
    condition: "heatmap_left_bottom_whitespace_excess == false (Heatmap left main card fill 82%-94%, bottom whitespace <=24px)"
    phase: during
    level: block
    draft_skip: true
    scope: heatmap
    category: layout

  - id: G57
    condition: "timeline_anchor_missing == false (Milestone contains dot/year/card/connection)"
    phase: during
    level: block
    draft_skip: true
    scope: milestone-timeline
    category: layout

  - id: G58
    condition: "timeline_card_overlap_excess == false (Event card horizontal overlap <=16px)"
    phase: during
    level: block
    draft_skip: true
    scope: milestone-timeline
    category: layout

  - id: G59
    condition: "timeline_phase_segmentation_missing == false (Contains phase divider line/labels)"
    phase: during
    level: block
    draft_skip: true
    scope: milestone-timeline
    category: layout

  # ── Visual (Visual Precision) ──────────────────────────────────

  - id: G60
    condition: "Allow controlled slight overlap (<= 8px), forbid deep occlusion of footer core info zone"
    phase: during
    level: block
    draft_skip: false
    scope: all
    category: visual

  - id: G61
    condition: "overflow_nodes == 0 (M05, includes cards/lists/tables/chart containers)"
    phase: during
    level: block
    draft_skip: true
    scope: all
    category: visual

  - id: G62
    condition: "color_richness_insufficient == false (Non-cover pages >=2 semantic color tiers)"
    phase: during
    level: block
    draft_skip: true
    scope: analysis
    category: visual

  - id: G63
    condition: "semantic_color_mismatch == false (Color matches text semantics/value direction)"
    phase: during
    level: block
    draft_skip: true
    scope: all
    category: visual

  - id: G64
    condition: "border_consistency_violation == false (Full deck single semantic border width token)"
    phase: during
    level: block
    draft_skip: true
    scope: all
    category: visual

  - id: G65
    condition: "list_icon_inconsistency == false (Only for li list item icon consistency, ignore card icons)"
    phase: during
    level: warn
    draft_skip: true
    scope: list
    category: visual

  - id: G66
    condition: "semantic_color_ratio_ok (Brand color ratio reasonable, exempt chart-heavy pages)"
    phase: during
    level: info
    draft_skip: true
    scope: analysis
    category: visual

  - id: G67
    condition: "Semantic colors land on insight/status/KPI components (not just chart lines)"
    phase: during
    level: warn
    draft_skip: true
    scope: analysis
    category: visual

  # ── Brand (Brand Consistency) ──────────────────────────────────

  - id: G68
    condition: "Brand style consistent (reference ppt-brand-system)"
    phase: during
    level: block
    draft_skip: false
    scope: all
    category: brand

  - id: G69
    condition: "Debug controls removed (brand switcher, dev ruler, etc.)"
    phase: during
    level: block
    draft_skip: true
    scope: all
    category: brand

  - id: G70
    condition: "Charts redraw correctly after brand switch (50ms delay + chart.resize)"
    phase: post
    level: block
    draft_skip: true
    scope: all
    category: brand

  # ── Post-generation ────────────────────────────

  - id: G71
    condition: "Charts render normally after browser open (not blank)"
    phase: post
    level: block
    draft_skip: false
    scope: all
    category: structural

  - id: G72
    condition: "Full deck copy density balanced, no obvious 'strong chart weak text' pages"
    phase: post
    level: block
    draft_skip: true
    scope: all
    category: content

  - id: G73
    condition: "Key pages meet 'ready for direct presentation' standard"
    phase: post
    level: block
    draft_skip: true
    scope: all
    category: content

  - id: G74
    condition: "No obvious hierarchy gaps after visual comparison with target reference style (e.g., Notion)"
    phase: post
    level: warn
    draft_skip: true
    scope: all
    category: visual

  - id: G75
    condition: "chart_overflow_card == false (Chart visual elements do not exceed card border)"
    phase: post
    level: warn
    draft_skip: true
    scope: all
    category: visual

  - id: G76
    condition: "axis_label_clipping_risk == false (Axis labels not clipped by canvas boundary)"
    phase: post
    level: warn
    draft_skip: true
    scope: all
    category: visual

  - id: G77
    condition: "runtime_profile_matrix_ok == true (M06, passes across viewport+dpr scenarios)"
    phase: post
    level: block
    draft_skip: true
    scope: all
    category: visual

  - id: G78
    condition: "hidden_overflow_masking_risk == false (M07, forbid overflow:hidden to mask overflow)"
    phase: post
    level: block
    draft_skip: true
    scope: all
    category: visual

  - id: G79
    condition: "main_overflow_without_node_overflow == false (Triggered when M02 fails AND overflow_nodes==0, identifies main area total overflow blind spot)"
    phase: post
    level: warn
    draft_skip: true
    scope: all
    category: visual

  - id: G80
    condition: "main_stack_overflow_risk_px <= 8 (M04, main area allows at most 8px intrusion into footer safety zone)"
    phase: post
    level: block
    draft_skip: true
    scope: all
    category: visual

  - id: G81
    condition: "Production mode must use playwright-runtime (forbid static-fallback as release validation basis)"
    phase: post
    level: block
    draft_skip: true
    scope: all
    category: structural

  - id: G83
    condition: "Chart container runtime height sufficient (clientHeight >= 150px)"
    phase: post
    level: block
    draft_skip: false
    scope: all
    category: visual

  - id: G82
    condition: "visual_collapse_risk == 0 (M08, forbid chart container height < 140px)"
    phase: post
    level: block
    draft_skip: true
    scope: all
    category: visual